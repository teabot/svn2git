#!/bin/sh

set -e -u

SVN_URL=$1
GIT_URL=$2
SVN_NAME=${SVN_URL##*/}
GIT_NAME=${GIT_URL##*/}

echo Fetching from ${SVN_URL}
git svn clone --trunk=trunk --branches=branches --tags=tags --prefix=svn/ --no-metadata $SVN_URL

echo Transforming local git repository $GIT_NAME
cd $SVN_NAME
git svn-abandon-fix-refs
mkdir .git/info/grafts
git-svn-abandon-cleanup

# find latest release tag
LATEST_RELEASE_TAG=`git tag | sort -r | head -1`
echo Creating release branch with tag $LATEST_RELEASE_TAG

git checkout $LATEST_RELEASE_TAG
git branch release
git checkout master

cat > .gitignore << EOF
# Eclipse files
.classpath
.settings
.project
.springBeans

# Netbeans files
nbactions.xml

# Maven target folder
target/

# Any left over .svn folders
.svn/

# MAC stuff
.DS_Store
EOF

git add .gitignore
git commit -m "Default gitignore for eclipse/java project"

git remote add origin $GIT_URL
git push origin --all --set-upstream
git push origin --tags

cd ..
chmod -R u+w $SVN_NAME
rm -r $SVN_NAME

echo Marking $GIT_NAME as migrated
svn co $SVN_URL
cd $SVN_NAME
mkdir '_MIGRATED TO GIT'
svn add '_MIGRATED TO GIT'
svn ci -m "Migrated to Git"
cd ..
chmod -R u+w $SVN_NAME
rm -r $SVN_NAME

echo 'Done'

